-- =========================
--      C00lmenu FINAL
-- =========================

-- SERVICES
local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local mouse = Players.LocalPlayer:GetMouse()
local cam = workspace.CurrentCamera

-- PLAYER
local player = Players.LocalPlayer

local function getChar()
	local c = player.Character or player.CharacterAdded:Wait()
	return c, c:WaitForChild("Humanoid"), c:WaitForChild("HumanoidRootPart")
end

local char, hum, hrp = getChar()
player.CharacterAdded:Connect(function()
	char, hum, hrp = getChar()
end)

-- =========================
-- GUI
-- =========================

local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "C00lmenu"

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 380, 0, 650)
frame.Position = UDim2.new(0, 20, 0.2, 0)
frame.BackgroundColor3 = Color3.fromRGB(15,15,15)
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,14)

local stroke = Instance.new("UIStroke", frame)
stroke.Color = Color3.fromRGB(255,0,0)
stroke.Thickness = 3

-- CREDIT
local credit = Instance.new("TextLabel", frame)
credit.Size = UDim2.new(1,0,0,22)
credit.Position = UDim2.new(0,0,0,6)
credit.BackgroundTransparency = 1
credit.Text = "Made by: account_c00l and 125234dsdad"
credit.Font = Enum.Font.GothamBold
credit.TextScaled = true
credit.TextColor3 = Color3.fromRGB(255,0,0)

-- UI HELPER
local function makeButton(text, y)
	local b = Instance.new("TextButton", frame)
	b.Size = UDim2.new(0,300,0,38)
	b.Position = UDim2.new(0.5,0,y,0)
	b.AnchorPoint = Vector2.new(0.5,0)
	b.Text = text
	b.Font = Enum.Font.GothamBold
	b.TextScaled = true
	b.TextColor3 = Color3.new(1,1,1)
	b.BackgroundColor3 = Color3.fromRGB(30,30,30)
	b.BorderSizePixel = 0
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,10)
	local s = Instance.new("UIStroke", b)
	s.Color = Color3.fromRGB(255,0,0)
	s.Thickness = 2
	return b
end

-- TELEPORT
local tpBox = Instance.new("TextBox", frame)
tpBox.Size = UDim2.new(0,300,0,36)
tpBox.Position = UDim2.new(0.5,0,0.065,0)
tpBox.AnchorPoint = Vector2.new(0.5,0)
tpBox.PlaceholderText = "player name"
tpBox.Font = Enum.Font.Gotham
tpBox.TextScaled = true
tpBox.BackgroundColor3 = Color3.fromRGB(25,25,25)
tpBox.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", tpBox).CornerRadius = UDim.new(0,10)

local tpBtn = makeButton("Teleport", 0.145)
tpBtn.MouseButton1Click:Connect(function()
	local name = tpBox.Text:lower()
	for _,p in ipairs(Players:GetPlayers()) do
		if p.Name:lower():sub(1,#name) == name and p.Character then
			hrp.CFrame = p.Character.HumanoidRootPart.CFrame * CFrame.new(0,0,3)
		end
	end
end)

-- BUTTONS
local y = 0.255
local g = 0.075

local speedUp   = makeButton("Speed +", y) y+=g
local speedDown = makeButton("Speed -", y) y+=g
local jumpUp    = makeButton("Jump +", y) y+=g
local jumpDown  = makeButton("Jump -", y) y+=g
local curseBtn  = makeButton("Body Curse", y) y+=g
local espBtn    = makeButton("ESP OFF", y) y+=g
local flingBtn  = makeButton("Fling OFF", y) y+=g

-- NOCIP BUTTON
local noclipOn = false
local noclipBtn = makeButton("Noclip OFF", y) y+=g

noclipBtn.MouseButton1Click:Connect(function()
	noclipOn = not noclipOn
	noclipBtn.Text = noclipOn and "Noclip ON" or "Noclip OFF"
	noclipBtn.BackgroundColor3 = noclipOn and Color3.fromRGB(0,120,0) or Color3.fromRGB(30,30,30)
end)

-- FLY BUTTON + SPEED TEXTBOX
local flyBtn = makeButton("Fly OFF", y)
local flySpeedBox = Instance.new("TextBox", frame)
flySpeedBox.Size = UDim2.new(0,80,0,38)
flySpeedBox.Position = UDim2.new(0.5, 160, y, 0)
flySpeedBox.AnchorPoint = Vector2.new(0.5,0)
flySpeedBox.PlaceholderText = "70"
flySpeedBox.Font = Enum.Font.Gotham
flySpeedBox.TextScaled = true
flySpeedBox.BackgroundColor3 = Color3.fromRGB(25,25,25)
flySpeedBox.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", flySpeedBox).CornerRadius = UDim.new(0,8)

-- DASH BUTTON
local dashBtn = makeButton("Dash", y+0.075) y+=g
dashBtn.MouseButton1Click:Connect(function()
	local char = player.Character
	local hrp = char and char:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local lookVector = hrp.CFrame.LookVector
	local distance = 10
	local speed = 100
	local traveled = 0

	while traveled < distance do
		RunService.RenderStepped:Wait()
		local step = math.min(speed * RunService.RenderStepped:Wait(), distance - traveled)
		hrp.CFrame = hrp.CFrame + lookVector * step
		traveled = traveled + step
	end
end)

-- SPEED / JUMP BUTTONS
speedUp.MouseButton1Click:Connect(function() hum.WalkSpeed += 5 end)
speedDown.MouseButton1Click:Connect(function() hum.WalkSpeed = math.max(0, hum.WalkSpeed - 5) end)
jumpUp.MouseButton1Click:Connect(function() hum.JumpPower += 5 end)
jumpDown.MouseButton1Click:Connect(function() hum.JumpPower = math.max(0, hum.JumpPower - 5) end)

-- BODY CURSE
local cursed = false
local saved = {}
curseBtn.MouseButton1Click:Connect(function()
	cursed = not cursed
	for _,v in ipairs(char:GetDescendants()) do
		if v:IsA("BasePart") then
			if cursed then
				saved[v] = {v.Color, v.Material}
				v.Color = Color3.fromRGB(255,0,0)
				v.Material = Enum.Material.Neon
			elseif saved[v] then
				v.Color = saved[v][1]
				v.Material = saved[v][2]
			end
		end
	end
end)

-- ESP
local espOn = false
local espObjs = {}

local function addESP(p)
	if p == player or not p.Character then return end
	local head = p.Character:FindFirstChild("Head")
	if not head then return end

	local hl = Instance.new("Highlight", p.Character)
	hl.FillColor = Color3.fromRGB(255,0,0)
	hl.OutlineColor = Color3.fromRGB(255,0,0)

	local bb = Instance.new("BillboardGui", head)
	bb.Size = UDim2.new(0,220,0,50)
	bb.StudsOffset = Vector3.new(0,2.8,0)
	bb.AlwaysOnTop = true

	local t = Instance.new("TextLabel", bb)
	t.Size = UDim2.new(1,0,1,0)
	t.BackgroundTransparency = 1
	t.Text = p.Name
	t.Font = Enum.Font.GothamBold
	t.TextScaled = true
	t.TextColor3 = Color3.fromRGB(255,0,0)
	t.TextStrokeTransparency = 0

	espObjs[p] = {hl, bb}
end

local function clearESP()
	for _,objs in pairs(espObjs) do
		for _,o in ipairs(objs) do o:Destroy() end
	end
	espObjs = {}
end

espBtn.MouseButton1Click:Connect(function()
	espOn = not espOn
	espBtn.Text = espOn and "ESP ON" or "ESP OFF"
	espBtn.BackgroundColor3 = espOn and Color3.fromRGB(120,0,0) or Color3.fromRGB(30,30,30)
	if espOn then
		for _,p in ipairs(Players:GetPlayers()) do addESP(p) end
	else
		clearESP()
	end
end)

-- FLING
local hiddenfling = false
local flingThread
if not ReplicatedStorage:FindFirstChild("juisdfj0i32i0eidsuf0iok") then
    local detection = Instance.new("Decal")
    detection.Name = "juisdfj0i32i0eidsuf0iok"
    detection.Parent = ReplicatedStorage
end

local function fling()
	local lp = Players.LocalPlayer
	local c, hrp, vel, movel = nil, nil, nil, 0.1
	while hiddenfling do
		RunService.Heartbeat:Wait()
		c = lp.Character
		hrp = c and c:FindFirstChild("HumanoidRootPart")
		if hrp then
			vel = hrp.Velocity
			hrp.Velocity = vel * 10000 + Vector3.new(0,10000,0)
			RunService.RenderStepped:Wait()
			hrp.Velocity = vel
			RunService.Stepped:Wait()
			hrp.Velocity = vel + Vector3.new(0,movel,0)
			movel = -movel
		end
	end
end

flingBtn.MouseButton1Click:Connect(function()
	hiddenfling = not hiddenfling
	flingBtn.Text = hiddenfling and "Fling ON" or "Fling OFF"
	flingBtn.BackgroundColor3 = hiddenfling and Color3.fromRGB(120,0,0) or Color3.fromRGB(30,30,30)

	if hiddenfling then
		flingThread = coroutine.create(fling)
		coroutine.resume(flingThread)
	end
end)

-- =========================
-- FLY (FIXED FINAL)
-- =========================

local flyOn = false
local flySpeed = 70 -- default
local bv, bg

-- Fly toggle button
flyBtn.MouseButton1Click:Connect(function()
	flyOn = not flyOn
	flyBtn.Text = flyOn and "Fly ON" or "Fly OFF"
	flyBtn.BackgroundColor3 = flyOn and Color3.fromRGB(0,120,0) or Color3.fromRGB(30,30,30)

	if flyOn then
		if hrp then
			bv = Instance.new("BodyVelocity", hrp)
			bv.MaxForce = Vector3.new(1e9,1e9,1e9)
			bv.Velocity = Vector3.zero

			bg = Instance.new("BodyGyro", hrp)
			bg.MaxTorque = Vector3.new(1e9,1e9,1e9)
			bg.CFrame = hrp.CFrame

			hum.PlatformStand = true
		end
	else
		if bv then bv:Destroy() end
		if bg then bg:Destroy() end
		hum.PlatformStand = false
	end
end)

-- Fly speed textbox (fully fixed)
flySpeedBox.ClearTextOnFocus = true
flySpeedBox.Focused:Connect(function()
	flySpeedBox.Text = ""
end)
flySpeedBox.Changed:Connect(function(property)
	if property == "Text" then
		local value = tonumber(flySpeedBox.Text)
		if value and value > 0 then
			flySpeed = value
		end
	end
end)

-- Movement update
RunService.RenderStepped:Connect(function()
	-- FLY
	if flyOn and hrp and bv and bg then
		local dir = Vector3.zero
		if UIS:IsKeyDown(Enum.KeyCode.W) then dir += cam.CFrame.LookVector end
		if UIS:IsKeyDown(Enum.KeyCode.S) then dir -= cam.CFrame.LookVector end
		if UIS:IsKeyDown(Enum.KeyCode.A) then dir -= cam.CFrame.RightVector end
		if UIS:IsKeyDown(Enum.KeyCode.D) then dir += cam.CFrame.RightVector end
		if UIS:IsKeyDown(Enum.KeyCode.Space) then dir += Vector3.new(0,1,0) end
		if UIS:IsKeyDown(Enum.KeyCode.LeftShift) then dir -= Vector3.new(0,1,0) end

		bv.Velocity = dir.Magnitude > 0 and dir.Unit * flySpeed or Vector3.zero
		bg.CFrame = CFrame.new(hrp.Position, hrp.Position + cam.CFrame.LookVector)
	end

	-- NOCLIP
	if noclipOn and char then
		for _, part in ipairs(char:GetDescendants()) do
			if part:IsA("BasePart") and part.CanCollide then
				part.CanCollide = false
			end
		end
	elseif char then
		for _, part in ipairs(char:GetDescendants()) do
			if part:IsA("BasePart") and not part.CanCollide then
				part.CanCollide = true
			end
		end
	end
end)
